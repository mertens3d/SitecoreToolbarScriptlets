javascript:(function(){var HtmlToInject = "<body><div><button id='btnEdit' type='button'>sc_mode=edit</button> <button id='btnPrev' type='button'>sc_mode=prev</button> <button id='btnNorm' type='button'>sc_mode=normal</button> <button id='btnAdminB' type='button'>Admin B</button> <button id='btnDesktop' type='button'>Desktop</button> <button id='btnSaveTheTrees' type='button'>Save the Trees</button> <button id='btnPlantTheTrees' type='button'>Plant the Trees</button> <button id='btnDrawLocalStorage' type='button'>Local Storage</button></div><textarea id='ta-debug'></textarea></body>";
var jsToInject = "var xyyz,dog='';class Debug{constructor(){this.__indentCount=0}Log(text){text='  '.repeat(this.__indentCount)+text,console.log(text);var ta=document.getElementById('ta-debug');ta&&(ta.value+=text+'\\n\\r',ta.scrollTop=ta.scrollHeight)}FuncStart(text){text='s) '+text,this.Log(text),this.__indentCount++}FuncEnd(text){text='e) '+text,this.__indentCount--,this.Log(text)}Error(container,text){container||(container='unknown'),text||(text='unknown');var logText='** ERROR ** '+container+':'+text;this.Log(logText)}}class AllTreeStorageStruct{constructor(){this.empty='empty'}}class ClassOneLivingIframe{constructor(iframeIndex,iframeElem){xyyz.debug.Log('s) OneLivingIframeData: '+iframeIndex),this.Index=iframeIndex,this.IframeElem=iframeElem,this.DocElem=iframeElem.contentDocument,xyyz.debug.Log('e) OneLivingIframeData')}}class LocationManager{constructor(){this.empty='empty'}}class OneTreeNode{constructor(nodeId,nodeFriendly){this.NodeId=nodeId,this.NodeFriendly=nodeFriendly}}class PageData{constructor(openerWindow){xyyz.debug.FuncStart(this.constructor.name),openerWindow?(this.Opener={},this.Opener.Window=openerWindow,this.Opener.Document=openerWindow.document):xyyz.debug.Error(this.constructor.name,'No Opener Page'),this.DebugInfo(),xyyz.debug.FuncEnd(this.constructor.name)}CurrentOpenerPageState(){xyyz.debug.FuncStart(this.CurrentOpenerPageState.name);var toReturn=xyyz.InjectConst.PageType.Unknown;if(this.Opener.Window){var currentLoc=this.Opener.Document.location.href;xyyz.debug.Log('currentLoc: '+currentLoc),toReturn=currentLoc.indexOf(xyyz.InjectConst.Url.Login)>-1?xyyz.InjectConst.PageType.LoginPage:currentLoc.indexOf(xyyz.InjectConst.Url.Desktop)>-1?xyyz.InjectConst.PageType.Desktop:currentLoc.indexOf(xyyz.InjectConst.Url.ContentEditor)>-1?xyyz.InjectConst.PageType.ContentEditor:xyyz.InjectConst.PageType.Unknown}return xyyz.debug.FuncEnd(this.CurrentOpenerPageState.name+' '+toReturn),toReturn}DebugInfo(){xyyz.debug.FuncStart(this.DebugInfo.name),xyyz.debug.Log(this.Opener.Window),xyyz.debug.Log(this.Opener.Document),xyyz.debug.FuncEnd(this.DebugInfo.name)}}class TreeDataManager{constructor(){this.CreateNewAllTreeData()}PutTreeData(newTreeData){xyyz.debug.FuncStart(this.PutTreeData.name+' '+JSON.stringify(newTreeData));var dataAsString=JSON.stringify(newTreeData);xyyz.debug.Log('dataAsString: '+dataAsString),this.__allTreeData.AllTreeDataAr.push(dataAsString);var allTreeAsString=JSON.stringify(this.__allTreeData);window.localStorage.setItem(xyyz.InjectConst.Storage.Root,allTreeAsString),xyyz.debug.FuncEnd(this.PutTreeData.name)}CreateNewAllTreeData(){this.__allTreeData={TimeStamp:Date.now(),AllTreeDataAr:[]}}ShowDebugData(){xyyz.debug.FuncStart(this.ShowDebugData.name);for(var jdx=0;jdx<this.__allTreeData.length;jdx++){var oneTreeData=this.__allTreeData[jdx];xyyz.debug.Log('Tree: '+jdx+' '+oneTreeData)}xyyz.debug.FuncEnd(this.ShowDebugData.name)}}function SetScMode(newValue){var newValueB='='+newValue;window.opener.location.href=window.opener.location.href.replace('=normal',newValueB).replace('=preview',newValueB).replace('=edit',newValueB)}function AdminB(){xyyz.debug.FuncStart(this.AdminB.name),xyyz.PageData.Opener.Document.getElementById('UserName').setAttribute('value','admin'),xyyz.PageData.Opener.Document.getElementById('Password').setAttribute('value','b'),xyyz.PageData.Opener.Document.getElementById('LogInBtn').click(),xyyz.debug.FuncEnd(this.AdminB.name)}function Desktop(ownerWindow){xyyz.debug.FuncStart(this.Desktop.name+'**');var currentState=xyyz.PageData.CurrentOpenerPageState();currentState===xyyz.InjectConst.PageType.LoginPage?(xyyz.debug.Log('On Login page: '),AdminB(),setTimeout((function(){xyyz.Desktop()}),1e3)):currentState===xyyz.InjectConst.PageType.Desktop&&TriggerRedButton(ownerWindow),xyyz.debug.FuncEnd(this.Desktop.name)}function TriggerRedButton(ownerWindow){xyyz.debug.Log('TriggerRedButton'),setTimeout((function(){RedButton(ownerWindow,10)}),1500)}function RedButton(ownerWindow,iteration){xyyz.debug.Log();var found=ownerWindow.document.getElementById('StartButton');xyyz.debug.Log('Red Button: '+found+'  '+ownerWindow.location.href+' '+iteration),found?(found.click(),ownerWindow.document.querySelector('.scStartMenuLeftOption').click()):(iteration-=1)>0&&setTimeout((function(){RedButton(ownerWindow,iteration)}),1500)}(xyyz=xyyz||{}).InjectConst={ClassNames:{ContentTreeNode:'scContentTreeNode'},Url:{Desktop:'/sitecore/shell/default.aspx',Login:'/sitecore/login',ContentEditor:'/sitecore/shell/Applications/Content%20Editor.aspx'},Selector:{ContentTreeNodeGlyph:'.scContentTreeNodeGlyph',RootNodeId:'Tree_Node_11111111111111111111111111111111'},Storage:{Root:'xyyz'},TreeExpandedPng:'treemenu_expanded.png',MaxIter:100,prop:{AllTreeData:'AllTreeData'},Names:{HtmlToInject:'HtmlToInject',StylesToInject:'StylesToInject'},PageType:{Unknown:0,LoginPage:1,Desktop:2,ContentEditor:3}},(xyyz=(xyyz=xyyz||{})||{}).OneCEIframe=function(){this.Index=-1,this.TreeData={}},xyyz.TreeData=function(){this.DateStamp=Date.now(),this.AllCEIframes=[]},xyyz.StorageMan={DrawStorage:function(){xyyz.debug.Log(window.localStorage.getItem(xyyz.InjectConst.Storage.Root))},GetTreeData:function(treeIdx){xyyz.debug.Log('s) GetTreeData');var foundInStorageJson=window.localStorage.getItem(xyyz.InjectConst.Storage.Root);if(foundInStorageJson){var allTreeDataAr=JSON.parse(foundInStorageJson)[xyyz.InjectConst.prop.AllTreeData];allTreeDataAr.length<=treeIdx&&allTreeDataAr[treeIdx]}return xyyz.debug.Log('e) GetTreeData'),treeIdx}},(xyyz=(xyyz=xyyz||{})||{}).ManyTrees={GetAllLiveIframeData:function(targetDoc){xyyz.debug.FuncStart(this.GetAllLiveIframeData.name);var toReturn=[],iframeAr=targetDoc.querySelectorAll('iframe[src*=content]');if(iframeAr){xyyz.debug.Log('iframeAr: '+iframeAr.length);for(var ifrIdx=0;ifrIdx<iframeAr.length;ifrIdx++)xyyz.debug.Log('pushing: '+ifrIdx),toReturn.push(new ClassOneLivingIframe(ifrIdx,iframeAr[ifrIdx]))}return xyyz.debug.FuncEnd(this.GetAllLiveIframeData.name+' '+toReturn.length),toReturn},PlantTheTrees:function(targetDoc,treeIdx){xyyz.debug.Log('s) LookAtExistingData: '+treeIdx);var foundInStorage=xyyz.StorageMan.GetTreeData(treeIdx);if(foundInStorage){xyyz.debug.Log('foundInStorage: '+foundInStorage);var fromStorageAr=foundInStorage.split(',');if(fromStorageAr){xyyz.debug.Log('foundAr: '+fromStorageAr.length+' '+fromStorageAr);this.GetAllLiveIframeData(targetDoc)[treeIdx];for(var idx=0;idx<fromStorageAr.length;idx++){var candidate=fromStorageAr[idx].replace(/\u0022/gi,'');candidate=candidate.replace('[','').replace(']',''),xyyz.debug.Log('candidate: '+candidate);var foundOnPage=targetIframe.getElementById(candidate);if(foundOnPage){xyyz.debug.Log('foundOnPage');var currentSrc=foundOnPage.getAttribute('src');xyyz.debug.Log('currentSrc'+currentSrc),currentSrc.indexOf('treemenu_expanded.png')<0&&(xyyz.debug.Log('clicking it'),foundOnPage.click())}}}}},SaveOneContentEditor:function(index,docElem){xyyz.debug.FuncStart(this.SaveOneContentEditor.name),index||(index=-1),docElem||(docElem=xyyz.PageData.Opener.Document,xyyz.debug.Log('Assigning docElem: '+docElem));var oneCeData=xyyz.OneTree.GetOneLiveTreeData(index,docElem);xyyz.TreeDataMan.PutTreeData(oneCeData),xyyz.debug.FuncEnd(this.SaveOneContentEditor.name)},SaveOneDesktop:function(){xyyz.debug.FuncStart(this.SaveOneDesktop.name);var livingIframeAr=this.GetAllLiveIframeData(targetDoc);if(livingIframeAr&&livingIframeAr.length>0)for(var iframeIdx=0;iframeIdx<livingIframeAr.length;iframeIdx++){xyyz.debug.Log('iframeIdx: '+iframeIdx);var targetIframeObj=livingIframeAr[iframeIdx];xyyz.debug.Log('targetIframe: '+JSON.stringify(targetIframeObj)),this.SaveOneContentEditor(iframeIdx,targetIframeObj.DocElem)}xyyz.debug.Log('done gathering tree data'),xyyz.TreeDataMan.ShowDebugData(),xyyz.debug.FuncEnd(this.SaveOneDesktop.name)},SaveAllTrees:function(){xyyz.debug.FuncStart(this.SaveAllTrees.name),xyyz.TreeDataMan.CreateNewAllTreeData();var currentState=xyyz.PageData.CurrentOpenerPageState();currentState===xyyz.InjectConst.PageType.ContentEditor?this.SaveOneContentEditor():currentState===xyyz.InjectConst.PageType.Desktop?this.SaveOneDesktop():xyyz.debug.Error(this.SaveAllTrees.name,'Invalid page location '+currentState),xyyz.debug.FuncEnd(this.SaveAllTrees.name)}},(xyyz=xyyz||{}).OneTree={GetFriendlyNameFromNode:function(inputNode){xyyz.debug.FuncStart(this.GetFriendlyNameFromNode.name);var toReturn='unknown',treeNode=inputNode.parentNode.querySelector('[id^=Tree_Node_]');return treeNode?toReturn=treeNode.innerText:xyyz.debug.Log('No treeNode'),xyyz.debug.FuncEnd(this.GetFriendlyNameFromNode.name+' '+toReturn),toReturn},WalkNodeRecursive:function(targetNode,depth){var toReturn=[];if(depth-=1,targetNode){if(targetNode.className===xyyz.InjectConst.ClassNames.ContentTreeNode){var firstImg=targetNode.querySelector(xyyz.InjectConst.Selector.ContentTreeNodeGlyph);if(firstImg)if(firstImg.getAttribute('src').indexOf(xyyz.InjectConst.TreeExpandedPng)>-1){var friendlyName=this.GetFriendlyNameFromNode(firstImg);toReturn.push(new OneTreeNode(firstImg.id,friendlyName))}}var childNodes=targetNode.children;if(childNodes&&childNodes.length>0&&depth>0)for(var jdx=0;jdx<childNodes.length;jdx++){var oneChild=childNodes[jdx];toReturn=toReturn.concat(this.WalkNodeRecursive(oneChild,depth))}}return toReturn},GetOneLiveTreeData:function(idx,targetDoc){xyyz.debug.FuncStart(this.GetOneLiveTreeData.name+' idx: '+idx);var toReturn=[];if(targetDoc){xyyz.debug.Log(JSON.stringify(targetDoc));var rootNode=targetDoc.getElementById(xyyz.InjectConst.Selector.RootNodeId);if(rootNode){xyyz.debug.Log('rootNode: '+rootNode.innerHTML);var rootParent=rootNode.parentElement;toReturn=this.WalkNodeRecursive(rootParent,xyyz.InjectConst.MaxIter),xyyz.debug.Log('foundNodes count: '+toReturn.length);var nodesAsString=JSON.stringify(toReturn);xyyz.debug.Log('toReturn as string: '+nodesAsString)}else xyyz.debug.Error(this.GetOneLiveTreeData.name,'no root node')}else xyyz.debug.Error(this.GetOneLiveTreeData.name,'no targetDoc');return xyyz.debug.FuncEnd(this.GetOneLiveTreeData.name),toReturn}},(xyyz=xyyz||{}).WireMenuButtons=function(){xyyz.debug.Log('s) WireMenuButtons'),document.getElementById('btnEdit').onclick=function(){SetScMode('edit')},document.getElementById('btnPrev').onclick=function(){SetScMode('preview')},document.getElementById('btnNorm').onclick=function(){SetScMode('normal')},document.getElementById('btnAdminB').onclick=function(){AdminB()},document.getElementById('btnDesktop').onclick=function(){Desktop(window.opener)},document.getElementById('btnSaveTheTrees').onclick=function(){xyyz.ManyTrees.SaveAllTrees()},document.getElementById('btnPlantTheTrees').onclick=function(){xyyz.ManyTrees.PlantTheTrees(window.opener.document,0)},document.getElementById('btnDrawLocalStorage').onclick=function(){xyyz.StorageMan.DrawStorage()},xyyz.debug.Log('e) WireMenuButtons ')},(xyyz=xyyz||{}).debug=new Debug,xyyz.PageData=new PageData(window.opener),xyyz.TreeDataMan=new TreeDataManager,xyyz.WireMenuButtons();";
var StylesToInject = "button{color:green;background-color:light-gray;width:200px;border-radius:5px;height:30px;margin:7px;cursor:pointer}button:hover{background-color:#afff00}body{background-color:coral}textarea{width:100%;height:200px}";
var constants={taDebug:"ta-debug"},xyyz=xyyz||{};xyyz.ChildWindow={myWindow:null,WindowExists:function(){return this.mywindow&&"undefined"!==this.mywindow&&!this.mywindow.closed},WriteHtml:function(o){console.log("s) WriteHtml");var n="<head>";n+="<style>",console.log("marker a"),n+=StylesToInject,console.log("marker b"),n+="</style>",n+="<body>",n+=HtmlToInject,n+="<script>",n+=jsToInject,n+="<\/script>",n+="</body>",o.document.innerHtml="",o.document.write(n),console.log("e) WriteHtml")},CreateWindow:function(){console.log("new window"),console.log("Constants: "+constants.taDebug),window.mywindow=window.open("","mywindow","width=900, height=600"),this.WriteHtml(window.mywindow)},FocusWindow:function(){console.log("existing window"),window.mywindow.focus()}},xyyz.ChildWindow.WindowExists()?xyyz.ChildWindow.FocusWindow():xyyz.ChildWindow.CreateWindow();}());