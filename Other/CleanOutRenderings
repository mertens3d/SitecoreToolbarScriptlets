cls
$targetId = "xxxx"
$dryRun = $false
$defaultLayout = Get-LayoutDevice "Default"
$useFinalLayout = $True
$placeHolderRegex = "key='.*?'"

$targetItem = Get-Item -Path "master:" -Id $targetId
Write-Host 'Found target: ' $targetItem.Name


$markup = Read-Host 'Page Markup'

$foundPlaceholders = $markup | Select-String -Pattern $placeHolderRegex -AllMatches | ForEach-Object { $_.Matches } | ForEach-Object { $_.Value -replace "key='","" } | ForEach-Object { $_ -replace "'","" }

Write-Host "Found Placeholders in Markup: "
$foundPlaceholders | ForEach-Object { $_ }

$IconComponent = "xxxx"



$renderingsToKill = $IconComponent

$renderingsToKeep = $SomethingElse


function DoesPlaceholderExist {
	param([string]$needle)
	$found = $false

	$foundPlaceholders | ForEach-Object {
		if ($_ -match $needle) {
			$found = $true
		}
	}
	if ($needle.length -lt 5) {
		$found = $true
	}

	return $found
}

if ($markup.Length -gt 10) {



	if (Get-Layout $targetItem.FullPath)
	{
		$renderings = Get-Rendering -Item $targetItem -FinalLayout:$useFinalLayout


		foreach ($candidateRendering in $renderings) {

			$renderingItem = Get-Item ($candidateRendering.ItemId)
			$assignedPlaceholder = $candidateRendering.Placeholder
			$placeholderFound = DoesPlaceholderExist -Needle $assignedPlaceholder

			
			#Write-Host "Placeholder Exists?" $placeholderFound

			$matchFoundForKill = $false
			$matchFoundForKeep = $false

			$renderingsToKill | ForEach-Object {
				if ($_ -match $candidateRendering.ItemId) {
					$matchFoundForKill = $true
				}
			}

			$renderingsToKeep | ForEach-Object {
				if ($_ -match $candidateRendering.ItemId) {
					$matchFoundForKeep = $true
				}
			}

            if(!$placeholderFound){
                Write-Host "No Placeholder found: " $renderingItem.Name " "  $assignedPlaceholder " " $renderingItem.Name " " $candidateRendering.ItemId 
                #Write-Host "Found Name: " $renderingItem.Name $candidateRendering.ItemId " using target placeholder:" $candidateRendering.Placeholder
                
            }
		



			if (!$dryRun -and $matchFoundForKill -and !$matchFoundForKeep -and !$placeholderFound) {
			    Write-Host "Kill Match Found? " $matchFoundForKill
			    Write-Host "Keep Match Found? " $matchFoundForKeep
			
				Write-Host "Wet Run. Killing " $targetItem.Name $renderingItem.Name
				Write-Host "Wet Run"
				$confirmation = Read-Host "Cofirm remove "  $renderingItem.Name " at " $assignedPlaceholder
                
                if ($confirmation -eq 'y') {
    
				    $targetItem.Editing.BeginEdit()
				    Remove-Rendering -Item $targetItem -Instance $candidateRendering -FinalLayout:$useFinalLayout
				    $targetItem.Editing.EndEdit()
                    }
			}

			Write-Host ""
		}

		Publish-Item -Item $targetItem
	}
}
Write-Host "done"
